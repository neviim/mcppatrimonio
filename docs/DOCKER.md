# Guia Docker - MCP Patrim√¥nio

Documenta√ß√£o completa para executar o MCP Patrim√¥nio em containers Docker para produ√ß√£o.

## üìã √çndice

- [Vis√£o Geral](#vis√£o-geral)
- [Pr√©-requisitos](#pr√©-requisitos)
- [Instala√ß√£o R√°pida](#instala√ß√£o-r√°pida)
- [Configura√ß√£o](#configura√ß√£o)
- [Build da Imagem](#build-da-imagem)
- [Executando o Container](#executando-o-container)
- [Docker Compose](#docker-compose)
- [Monitoramento e Logs](#monitoramento-e-logs)
- [Integra√ß√£o com Claude Desktop](#integra√ß√£o-com-claude-desktop)
- [Troubleshooting](#troubleshooting)
- [Produ√ß√£o](#produ√ß√£o)

## üéØ Vis√£o Geral

O MCP Patrim√¥nio pode ser executado em containers Docker, oferecendo:

- ‚úÖ **Isolamento**: Ambiente isolado e reproduz√≠vel
- ‚úÖ **Portabilidade**: Roda em qualquer sistema com Docker
- ‚úÖ **Escalabilidade**: F√°cil deploy em m√∫ltiplos ambientes
- ‚úÖ **Seguran√ßa**: Execu√ß√£o com usu√°rio n√£o-root
- ‚úÖ **Efici√™ncia**: Imagem otimizada com multi-stage build

### Arquitetura Docker

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     Docker Host (Linux/Win/Mac)    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  Container: mcppatrimonio-server  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  Node.js 22.15.0 Alpine ‚îÇ  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  MCP Server             ‚îÇ  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  Port: stdio            ‚îÇ  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üï stdio/network
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      Cliente MCP (Claude)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß Pr√©-requisitos

### Requisitos M√≠nimos

- **Docker**: >= 20.10.0
- **Docker Compose**: >= 2.0.0 (opcional, mas recomendado)
- **Sistema Operacional**: Linux, macOS, Windows 10+ com WSL2
- **RAM**: 512 MB dispon√≠vel para o container
- **CPU**: 1 core

### Verificar Instala√ß√£o

```bash
# Verificar Docker
docker --version
# Sa√≠da esperada: Docker version 20.10.x ou superior

# Verificar Docker Compose
docker compose version
# Sa√≠da esperada: Docker Compose version v2.x.x

# Testar Docker
docker run hello-world
```

### Instalar Docker

**Linux (Ubuntu/Debian)**:
```bash
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER
```

**macOS**:
- Baixe [Docker Desktop for Mac](https://www.docker.com/products/docker-desktop)

**Windows**:
- Baixe [Docker Desktop for Windows](https://www.docker.com/products/docker-desktop)
- Habilite WSL2

## ‚ö° Instala√ß√£o R√°pida

### M√©todo 1: Docker Compose (Recomendado)

```bash
# 1. Clone o reposit√≥rio
git clone https://github.com/seu-usuario/mcppatrimonio.git
cd mcppatrimonio

# 2. Configure vari√°veis de ambiente
cp .env.example .env
nano .env  # Edite com suas configura√ß√µes

# 3. Build e inicie
docker compose up -d

# 4. Verifique status
docker compose ps
docker compose logs -f
```

### M√©todo 2: Docker CLI

```bash
# 1. Build da imagem
docker build -t mcppatrimonio:latest .

# 2. Execute o container
docker run -d \
  --name mcppatrimonio-server \
  -e PATRIMONIO_BASE_URL=https://api.example.com \
  -e PATRIMONIO_TOKEN=seu_token_aqui \
  -e NODE_ENV=production \
  -e LOG_LEVEL=info \
  --restart unless-stopped \
  mcppatrimonio:latest

# 3. Verifique logs
docker logs -f mcppatrimonio-server
```

## ‚öôÔ∏è Configura√ß√£o

### Vari√°veis de Ambiente

Crie arquivo `.env` na raiz do projeto:

```env
# Configura√ß√£o da API (OBRIGAT√ìRIO)
PATRIMONIO_BASE_URL=https://api.example.com
PATRIMONIO_TOKEN=seu_token_secreto_aqui

# Ambiente (OBRIGAT√ìRIO)
NODE_ENV=production

# Logging (opcional)
LOG_LEVEL=info

# Rate Limiting (opcional)
RATE_LIMIT_WINDOW_MS=60000
RATE_LIMIT_MAX_REQUESTS=100
```

### Arquivo docker-compose.yml

O arquivo `docker-compose.yml` j√° est√° configurado no projeto:

```yaml
version: '3.8'

services:
  mcppatrimonio:
    build:
      context: .
      dockerfile: Dockerfile
    image: mcppatrimonio:latest
    container_name: mcppatrimonio-server
    restart: unless-stopped

    env_file:
      - .env

    environment:
      NODE_ENV: production

    stdin_open: true
    tty: true

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
```

## üèóÔ∏è Build da Imagem

### Build B√°sico

```bash
# Build com tag latest
docker build -t mcppatrimonio:latest .

# Build com tag espec√≠fica
docker build -t mcppatrimonio:0.2.0 .

# Build com argumentos
docker build \
  --build-arg NODE_VERSION=18 \
  -t mcppatrimonio:latest .
```

### Build Multi-arquitetura

Para suportar ARM64 e AMD64:

```bash
# Criar builder multi-plataforma
docker buildx create --name multiarch --use

# Build para m√∫ltiplas arquiteturas
docker buildx build \
  --platform linux/amd64,linux/arm64 \
  -t mcppatrimonio:latest \
  --push \
  .
```

### Verificar Imagem

```bash
# Listar imagens
docker images | grep mcppatrimonio

# Inspecionar imagem
docker inspect mcppatrimonio:latest

# Verificar tamanho
docker images mcppatrimonio:latest --format "{{.Size}}"
# Esperado: ~150-200MB
```

## üöÄ Executando o Container

### Execu√ß√£o B√°sica

```bash
# Iniciar container
docker compose up -d

# Ou com Docker CLI
docker run -d \
  --name mcppatrimonio-server \
  --env-file .env \
  --restart unless-stopped \
  mcppatrimonio:latest
```

### Execu√ß√£o em Foreground (Debug)

```bash
# Ver logs em tempo real
docker compose up

# Ou com Docker CLI
docker run -it --rm \
  --name mcppatrimonio-server \
  --env-file .env \
  mcppatrimonio:latest
```

### Execu√ß√£o com Volumes (Logs Persistentes)

```bash
docker run -d \
  --name mcppatrimonio-server \
  --env-file .env \
  -v $(pwd)/logs:/app/logs \
  --restart unless-stopped \
  mcppatrimonio:latest
```

### Comandos de Gerenciamento

```bash
# Iniciar container parado
docker compose start
# ou
docker start mcppatrimonio-server

# Parar container
docker compose stop
# ou
docker stop mcppatrimonio-server

# Reiniciar container
docker compose restart
# ou
docker restart mcppatrimonio-server

# Remover container
docker compose down
# ou
docker rm -f mcppatrimonio-server
```

## üê≥ Docker Compose

### Comandos Principais

```bash
# Build e iniciar servi√ßos
docker compose up -d

# Rebuild for√ßado
docker compose up -d --build

# Ver logs
docker compose logs -f

# Ver logs de um servi√ßo espec√≠fico
docker compose logs -f mcppatrimonio

# Ver status dos servi√ßos
docker compose ps

# Parar todos os servi√ßos
docker compose down

# Parar e remover volumes
docker compose down -v
```

### Configura√ß√µes Avan√ßadas

**docker-compose.override.yml** (para desenvolvimento):

```yaml
version: '3.8'

services:
  mcppatrimonio:
    volumes:
      - ./src:/app/src:ro
    environment:
      NODE_ENV: development
      LOG_LEVEL: debug
```

Uso:
```bash
# Docker Compose usa automaticamente override
docker compose up -d
```

## üìä Monitoramento e Logs

### Visualizar Logs

```bash
# Logs em tempo real
docker compose logs -f

# √öltimas 100 linhas
docker compose logs --tail 100

# Logs com timestamp
docker compose logs -f -t

# Logs desde tempo espec√≠fico
docker compose logs --since 30m

# Filtrar por n√≠vel
docker logs mcppatrimonio-server 2>&1 | grep ERROR
```

### Health Check

```bash
# Verificar status de sa√∫de
docker inspect mcppatrimonio-server --format='{{.State.Health.Status}}'

# Ver √∫ltimos health checks
docker inspect mcppatrimonio-server --format='{{json .State.Health}}' | jq
```

### Estat√≠sticas de Recursos

```bash
# Stats em tempo real
docker stats mcppatrimonio-server

# Stats √∫nicos
docker stats --no-stream mcppatrimonio-server

# Uso de mem√≥ria
docker exec mcppatrimonio-server sh -c "ps aux | head -n 10"
```

### Executar Comandos no Container

```bash
# Shell interativo
docker exec -it mcppatrimonio-server sh

# Executar comando espec√≠fico
docker exec mcppatrimonio-server node --version

# Ver vari√°veis de ambiente
docker exec mcppatrimonio-server env

# Ver processos rodando
docker exec mcppatrimonio-server ps aux
```

## üîó Integra√ß√£o com Claude Desktop

### M√©todo 1: Docker com Stdio (Recomendado)

**Configura√ß√£o do Claude Desktop** (`claude_desktop_config.json`):

```json
{
  "mcpServers": {
    "Patrimonio": {
      "command": "docker",
      "args": [
        "run",
        "-i",
        "--rm",
        "--env-file",
        "C:\\caminho\\completo\\para\\mcppatrimonio\\.env",
        "mcppatrimonio:latest"
      ]
    }
  }
}
```

**Windows**:
```json
{
  "mcpServers": {
    "Patrimonio": {
      "command": "docker",
      "args": [
        "run",
        "-i",
        "--rm",
        "--env-file",
        "C:\\Users\\SeuUsuario\\mcppatrimonio\\.env",
        "mcppatrimonio:latest"
      ]
    }
  }
}
```

**macOS/Linux**:
```json
{
  "mcpServers": {
    "Patrimonio": {
      "command": "docker",
      "args": [
        "run",
        "-i",
        "--rm",
        "--env-file",
        "/home/usuario/mcppatrimonio/.env",
        "mcppatrimonio:latest"
      ]
    }
  }
}
```

### M√©todo 2: Container em Background + Script Wrapper

**1. Iniciar container em background**:
```bash
docker compose up -d
```

**2. Criar script wrapper** (`mcp-docker.sh`):
```bash
#!/bin/bash
docker exec -i mcppatrimonio-server node dist/index.js
```

**3. Configurar Claude Desktop**:
```json
{
  "mcpServers": {
    "Patrimonio": {
      "command": "/caminho/para/mcp-docker.sh"
    }
  }
}
```

## üêõ Troubleshooting

### Container n√£o inicia

**Problema**: Container para imediatamente ap√≥s iniciar.

**Solu√ß√£o**:
```bash
# Ver logs de erro
docker logs mcppatrimonio-server

# Verificar vari√°veis de ambiente
docker inspect mcppatrimonio-server --format='{{.Config.Env}}'

# Testar em foreground
docker compose up
```

### Erro de vari√°veis de ambiente

**Problema**: `PATRIMONIO_BASE_URL is required`

**Solu√ß√£o**:
```bash
# Verificar se .env existe e est√° correto
cat .env

# Testar com vari√°veis diretas
docker run -it --rm \
  -e PATRIMONIO_BASE_URL=https://api.test \
  -e PATRIMONIO_TOKEN=test123 \
  mcppatrimonio:latest
```

### Erro de mem√≥ria

**Problema**: Container crashando por falta de mem√≥ria.

**Solu√ß√£o**:
```bash
# Aumentar limite de mem√≥ria
docker run -d \
  --name mcppatrimonio-server \
  --env-file .env \
  --memory=1g \
  --memory-swap=1g \
  mcppatrimonio:latest
```

### Erro de conectividade com API

**Problema**: Container n√£o consegue acessar API externa.

**Solu√ß√£o**:
```bash
# Testar conectividade DNS
docker exec mcppatrimonio-server ping api.example.com

# Testar com curl
docker exec mcppatrimonio-server curl -v https://api.example.com

# Verificar network
docker network inspect bridge
```

### Imagem muito grande

**Problema**: Imagem Docker > 500MB

**Solu√ß√£o**:
```bash
# Rebuild com otimiza√ß√µes
docker build --no-cache -t mcppatrimonio:latest .

# Remover layers desnecess√°rias
docker image prune -a
```

### Logs n√£o aparecem

**Problema**: `docker logs` n√£o mostra sa√≠da.

**Solu√ß√£o**:
```bash
# Verificar se stdout/stderr est√£o redirecionados
docker inspect mcppatrimonio-server --format='{{.Config.Tty}}'

# Executar com -t flag
docker run -it --rm --env-file .env mcppatrimonio:latest
```

## üîê Produ√ß√£o

### Boas Pr√°ticas

1. **Secrets Management**:
```bash
# Use Docker secrets em vez de vari√°veis de ambiente
echo "meu_token_secreto" | docker secret create patrimonio_token -

docker service create \
  --name mcppatrimonio \
  --secret patrimonio_token \
  mcppatrimonio:latest
```

2. **Health Checks**:
```yaml
healthcheck:
  test: ["CMD", "node", "-e", "process.exit(0)"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 5s
```

3. **Resource Limits**:
```yaml
deploy:
  resources:
    limits:
      cpus: '1.0'
      memory: 512M
    reservations:
      cpus: '0.5'
      memory: 256M
```

4. **Logging**:
```yaml
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

5. **Security**:
```bash
# Executar com usu√°rio n√£o-root (j√° configurado no Dockerfile)
# Scan de vulnerabilidades
docker scan mcppatrimonio:latest

# Usar registry privado
docker tag mcppatrimonio:latest registry.example.com/mcppatrimonio:latest
docker push registry.example.com/mcppatrimonio:latest
```

### Deploy em Produ√ß√£o

**Docker Swarm**:
```bash
# Inicializar swarm
docker swarm init

# Deploy stack
docker stack deploy -c docker-compose.yml mcppatrimonio

# Ver services
docker service ls

# Escalar
docker service scale mcppatrimonio_mcppatrimonio=3
```

**Kubernetes**:
```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mcppatrimonio
spec:
  replicas: 2
  selector:
    matchLabels:
      app: mcppatrimonio
  template:
    metadata:
      labels:
        app: mcppatrimonio
    spec:
      containers:
      - name: mcppatrimonio
        image: mcppatrimonio:latest
        env:
        - name: PATRIMONIO_BASE_URL
          valueFrom:
            secretKeyRef:
              name: mcppatrimonio-secrets
              key: base-url
        - name: PATRIMONIO_TOKEN
          valueFrom:
            secretKeyRef:
              name: mcppatrimonio-secrets
              key: token
        resources:
          limits:
            cpu: "1"
            memory: "512Mi"
          requests:
            cpu: "500m"
            memory: "256Mi"
```

### Backup e Restore

```bash
# Backup da imagem
docker save mcppatrimonio:latest | gzip > mcppatrimonio-backup.tar.gz

# Restore da imagem
docker load < mcppatrimonio-backup.tar.gz

# Backup de volumes (se houver)
docker run --rm -v mcppatrimonio-data:/data -v $(pwd):/backup \
  alpine tar czf /backup/data-backup.tar.gz /data
```

### Monitoramento em Produ√ß√£o

**Prometheus + Grafana**:
```yaml
# docker-compose.yml
services:
  mcppatrimonio:
    # ... configura√ß√£o existente ...

  prometheus:
    image: prom/prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
```

### CI/CD

**GitHub Actions** (`.github/workflows/docker.yml`):
```yaml
name: Docker Build and Push

on:
  push:
    branches: [main]
    tags: ['v*']

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build Docker image
        run: docker build -t mcppatrimonio:${{ github.sha }} .

      - name: Push to registry
        run: |
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push mcppatrimonio:${{ github.sha }}
```

## üìö Comandos √öteis Resumidos

```bash
# Build e execu√ß√£o
docker compose up -d --build

# Ver logs
docker compose logs -f

# Status
docker compose ps

# Parar
docker compose down

# Rebuild completo
docker compose down && docker compose up -d --build

# Limpar tudo
docker compose down -v
docker system prune -a

# Health check
docker inspect mcppatrimonio-server --format='{{.State.Health.Status}}'

# Stats
docker stats mcppatrimonio-server --no-stream

# Shell no container
docker exec -it mcppatrimonio-server sh
```

---

**Documenta√ß√£o Docker Completa**

Para instala√ß√£o local, veja [INSTALLATION.md](INSTALLATION.md)
Para refer√™ncia de API, veja [API.md](API.md)
